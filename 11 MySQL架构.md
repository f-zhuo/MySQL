## MySQL架构

分层，分成四层：连接层，服务层，引擎层，存储层

![](https://github.com/f-zhuo/MySQL/raw/master/pictures/MySQL.png)

- 连接层

连接客户端，有一个线程池，可以对连接的客户端进行SSL的安全连接，进行权限验证。客户端和服务端的通信协议是半双工：任意时刻，要么是服务器向客户端发送数据，要么是客户端向服务端发送数据

- 服务层

提供SQL接口，对SQL语句进行解析和优化。解析器通过语法和文法规则对SQL进行验证和解析，如关键字是否正确，关键字使用顺序是否正确等，生成一个解析树。然后在优化查询器里会按照SQL自己的逻辑进行如执行顺序，是否使用索引等进行优化。该优化器基于成本，会预测执行计划的成本并选择最小的那种。如果是select语句，还会利用缓存，提高查询效率。服务层的解析，优化等都是组件，可以把优化组件拔除，提高执行效率

- 引擎层

是可插拔的，为不同的场景提供不同的存储引擎，存储引擎负责真正的数据存储和提取，最常用的两种是MyISAM和InnoDB。MySQL5.1之前默认使用MyISAM，之后是InnoDB

- 存储层

把数据存储在文件系统里，和存储引擎交互

分层原因：

MySQL采用分层架构能方便查找故障，直接定位到某层

### 查询执行过程

* 客户端向MySQL服务器发送一条查询请求
* 服务器首先检查查询缓存，如果命中缓存，则立刻返回存储在缓存中的结果。否则进入下一阶段
* 服务器进行SQL解析、预处理，再由优化器生成对应的执行计划
* MySQL根据执行计划，调用存储引擎的API来执行查询
* 将结果返回给客户端，同时缓存查询结果

查看存储引擎

```sql
show engines;

show variables like 'storage_engines';
```

InnoDB和MyISAM的比较

|    对比项    |       MyISAM       |             InnoDB             |
| :----------: | :----------------: | :----------------------------: |
|    主外键    |       不支持       |              支持              |
|     事务     |       不支持       |              支持              |
|   全文索引   |        支持        |             不支持             |
|      锁      | 表锁，不适合高并发 |      支持行锁，适合高并发      |
|     关注     |        性能        |              事务              |
|    表空间    |         小         |               大               |
|     缓存     |     只缓存索引     | 缓存索引和数据，故对内存要求高 |
|   适用语句   |       select       |         insert,update          |
| 保存表的行数 |         是         |               否               |

对于自增的字段，InnoDB建立索引必须只包含该字段；MyISAM可以包含其他字段

memory：也是一种存储引擎，使用该引擎的每个表都对应了一个文件，文件只有表结构，真实数据存储在内存里。使用hash索引，一旦重启/关机，数据就会丢失，适合一次性的表
